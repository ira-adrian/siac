{# Siarme\ExpedienteBundle\Resources\views\Externo\index.html.twig #}

{% extends 'frontend.html.twig' %}
{% block title %} PEDIDOS{% endblock %}
{% block stylesheets %}   
     <link href="{{ asset('bundles/expediente/plugins/boostrap3/css/bootstrap_cosmo.min.css') }}" type="text/css" rel="stylesheet"> 
    <link rel="stylesheet" href="{{ asset('bundles/expediente/plugins/font-awesome/css/font-awesome.min.css') }}">  
    <link href="{{ asset('bundles/expediente/plugins/datatables/jquery.dataTables.min.css')}}" type="text/css" rel="stylesheet">
    <style type="text/css" media="print">
        @media print {
            a[href]:after {
                content: none !important;
            }
        }
    </style>     
{% endblock %}
{% block body %}
<header>
  <nav class="navbar navbar-inverse hidden-print"  role = "navigation">
      <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <a class="navbar-brand"><span  class="glyphicon glyphicon-shopping-cart"></span> {{app.user.departamentoRm.organismo}}</a>
    </div>
      <ul class="nav navbar-nav">       
        <li><a href="{{ path('externo_index') }}" ><span class="glyphicon glyphicon-home" aria-hidden="true"></span> INICIO</a></li>   
        <li class="active"><a href="{{ path('externo_reporte') }}"  target="_blank"> <span class="glyphicon glyphicon-stats" ></span> REPORTE </a></li> 
      </ul> 
      <ul class="nav navbar-nav navbar-right">     
          <li data-toggle="tooltip" data-placement="bottom" title='Ver Perfil' >
            
      <a href="{{ path('usuario_show', { 'id': app.user.id }) }}"><span class="glyphicon glyphicon-user text-info"> </span> {{ app.user.usuario }}</a>
            </li>      
        <li>
             <a href="{{ path('usuario_logout') }}" >
                  <span class="glyphicon glyphicon-log-out" aria-hidden="true"></span>
                  Salir
              </a>           
        </li>        
      </ul> 
    </div><!-- /.container-fluid -->    
</nav>
</header>
<ul class="nav nav-pills hidden-print"  style="margin-bottom:1px;">
  <!-- Menu DERECHO *** IMPRIMIR - COPIAR -->
    <div class="pull-right">
            <li  role="presentation">
                <a href="javascript:if(window.print)window.print()" value="Imprimir" role="button"><!-- Printer-imprime el texto de clase="print" -->
                <span class="glyphicon glyphicon-print" ></span> Imprimir</a>
            </li>
    </div> 
</ul>
 <div class="container" id="copy">
 <div class="panel panel-warning">
    <div class="panel-heading">
      <h4 class="panel-title">
        <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion" href="#reporte">
          <span class="glyphicon glyphicon-plus  text-info"></span> <span class="glyphicon glyphicon-stats"></span> REPORTE
        </a>
      </h4>
    </div>
    <div id="reporte" class="collapse in">
      <div  class="panel-body ">
        <ol class="breadcrumb hidden-print"  style="margin-bottom:1px;"> 
            {% for year in ( ('now' | date("Y") - 2) .. ('now' | date("Y"))) %} 
                {% if year != anio %}
                  <li><a href="{{ path('externo_reporte', {'anio': year }) }}"> <span class="glyphicon glyphicon-calendar"></span>{{year}}</a></li>
                {% else %}
                    <li class="active"> 
                      <span class="glyphicon glyphicon-calendar text-success"></span> <strong>{{year}}</strong>
                    </li>
                {% endif %}
            {% endfor %}
        </ol>
         <div class="list-group-item" style="height: 100%;">
  {% set meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto",  "Septiembre",  "Octubre", "Noviembre", "Diciembre"] %}
              {% set reporteProcesos, tramites2, procesos,  cantidad , montoPresupuestado, sumaTotal, montoAdjudicado, mes= [], procesos_por_mes(app.user.departamentoRm, anio), {}, 0, 0, 0, 0, 0 %}

          {% for tramite in tramites2 | sort((a, b) => a.mes <=> b.mes) %}
            {% if loop.first %}
              {% set mes, cantidad , montoPresupuestado, montoAdjudicado, procesos = tramite.mes, 1, tramite.expediente.presupuestoOficial, tramite.montoAdjudica, procesos | merge([tramite])  %}
            {% elseif tramite.mes == mes %}
               {% set cantidad , montoPresupuestado, montoAdjudicado, procesos = cantidad  + 1 , montoPresupuestado + tramite.expediente.presupuestoOficial, montoAdjudicado + tramite.montoAdjudica,  procesos | merge([tramite])  %}
            {% else %}
             {% set  reporteProcesos = reporteProcesos | merge([{mes, cantidad , procesos, montoPresupuestado, montoAdjudicado}]) %}
                {% set  procesos = [] %}
             {% set mes, cantidad , montoPresupuestado, montoAdjudicado,  procesos = tramite.mes, 1, tramite.expediente.presupuestoOficial, tramite.montoAdjudica, procesos | merge([tramite]) %}
            {% endif %}
          {% endfor %}
               {% set  reporteProcesos = reporteProcesos | merge([{mes, cantidad ,  procesos, montoPresupuestado, montoAdjudicado}]) %}
           
<h3> PROCESOS ADJUDICADOS POR MES</h3>
        <table class="table table-striped table-hover tablaItem">
            <thead class="text-center">
             <tr>
                <th></th>
                <th>Mes</th>
                <th>Cantidad</th>
                <th>Monto Presupuestado</th>
                <th>Monto Adjudicado</th>
             </tr>
           </thead>
            <tbody class="panel">
                {% set sumaCantidad, sumaPresupuesto, sumaAdjudicado = 0, 0, 0 %}
              {% for reporte  in reporteProcesos %}
                <tr data-toggle="collapse" data-parent="#tablaGrupoRubro" data-target="#collapse{{loop.index}}">
                  <th>
                    {% if loop.first %} <span  data-toggle="popover" data-placement="top"  data-content="Haga Click para ver los PROCESOS"></span>{% endif %}
                    <span class="chevron glyphicon glyphicon-chevron-down text-info"  ></span></th>
                  <th>{% if reporte.mes == 0 %}  {{meses[reporte.mes ]}}  {% else %} {{meses[reporte.mes - 1]}}{% endif %}</th>
                  <td> {{reporte.cantidad}} </td>
                  <td>$ {{reporte.montoPresupuestado | number_format(2, ',', '.')}}</td>
                  <td>$ {{reporte.montoAdjudicado | number_format(2, ',', '.')}}</td>
                </tr> 
                <tr id="collapse{{loop.index}}" class="collapse">  
                   <td colspan="5">
                          {% set   tramites1, cantidad = reporte.procesos, reporte.cantidad %}
                        {% for tramite in  tramites1 if tramite.fechaDestino | date('Y') ==  anio  %}        
                        {# cabecera de tabla #}
                         {% if loop.first %}
                              <table class='{{(cantidad > 5)? "tablaTramite": " "}}  table table-responsive'>
                                  <thead>
                                    {{ include('ExpedienteBundle:'~ tramite.tipoTramite.slug ~':_thead_completo.html.twig') }}         
                                  </thead>
                                  <tbody>
                          {% endif %}   
                          
                                      {# filtro los tramites que no tienen expedientes #}
                                     {{ include('ExpedienteBundle:'~ tramite.tipoTramite.slug ~':_tbody_completo.html.twig') }}    
                         {% endfor %}
                                  </tbody>
                              </table>     

         
                    </td>
                </tr> 
                {% set sumaCantidad, sumaPresupuesto, sumaAdjudicado = 
                              sumaCantidad + reporte.cantidad , 
                              sumaPresupuesto +  reporte.montoPresupuestado, 
                              sumaAdjudicado +  reporte.montoAdjudicado 

                %}
              {% endfor %}
              <tr>
                <th></th>
                <th>Totales</th>
                <th>{{sumaCantidad}}</th>
                <th>$ {{sumaPresupuesto | number_format(2, ',', '.')}}</th>
                <th>$ {{sumaAdjudicado | number_format(2, ',', '.')}}</th>
              </tr> 
            </tbody>
        </table>
        <div id="chartContainer" style="height: 600px; max-width: 90%"></div>
</div>
{{ app.session.set('reporteProcesos', reporteProcesos) }}
          <div class="list-group-item" style="height: 100%;">
            <table class="table table-striped">
            <thead class="text-center">
              <tr> <h3> CANTIDAD DE PEDIDOS POR TRIMESTRE </h3> </tr>
             <tr>
                <th>Trimestres</th>
                <th>Cantidad</th>
                <th>Presupuesto</th>
             </tr>
           </thead>
            <tbody>

              {# set resportePorTrimestreSaf, sumaCantidad, sumaPresupuesto = tramites_por_trimestre_saf(2, anio, app.user.departamentoRm.organismo.id), 0, 0 #}
              {% set resportePorTrimestreSaf, sumaCantidad, sumaPresupuesto = tramites_por_trimestre(2, anio), 0, 0 %}
      
              {% for reporte  in resportePorTrimestreSaf %}
                <tr> 
                  <th>{{reporte.trimestre}}° Trimestre</th>
                  <td> {{reporte.cantidad}} </td>
                  <td>$ {{reporte.presupuesto | number_format(2, ',', '.')}}</td>
                </tr> 
                {% set sumaCantidad, sumaPresupuesto = 
                              sumaCantidad + reporte.cantidad , 
                              sumaPresupuesto +  reporte.presupuesto 

                %}
              {% endfor %}
              <tr>
                <th>Totales</th>
                <th>{{sumaCantidad}}</th>
                <th>$ {{sumaPresupuesto | number_format(2, ',', '.')}}</th>
              </tr> 
            </tbody>
          </table>
            <div id="chartTrimestre" style="height: 300px; max-width: 80%"></div>
          </div>
          
          <div class="list-group-item">
          <table class="table table-striped">
            <thead class="text-center">
              <tr> <h3> CANTIDAD DE PEDIDOS POR RUBRO</h3> </tr>
             <tr>
                <th>Rubro</th>
                <th>Cantidad</th>
                <th>Presupuesto</th>
             </tr>
           </thead>
            <tbody>
              {% set resportePorRubroSaf, sumaCantidad, sumaPresupuesto = tramites_por_rubro(2, anio), 0, 0 %}
      
              {% for reporte  in resportePorRubroSaf %}
                <tr> 
                  <th>{{reporte.tramite.rubro}}</th>
                  <td> {{reporte.cantidad}} </td>
                  <td>$ {{reporte.presupuesto | number_format(2, ',', '.')}}</td>
                </tr> 
                {% set sumaCantidad, sumaPresupuesto = 
                              sumaCantidad + reporte.cantidad , 
                              sumaPresupuesto +  reporte.presupuesto 

                %}
              {% endfor %}
              <tr>
                <th>Totales</th>
                <th>{{sumaCantidad}}</th>
                <th>$ {{sumaPresupuesto | number_format(2, ',', '.')}}</th>
              </tr> 
            </tbody>
          </table>
              <div id="chartRubro"  style="height: 700px; max-width: 80%;"></div>
          </div>

      </div>
    </div>
  </div>
 
</div>
{% endblock %}
{% block javascripts %}   
   <script src="{{ asset('bundles/expediente/plugins/jquery/jquery.min.js') }}"></script>
    <script src="{{ asset('bundles/expediente/plugins/boostrap3/js/bootstrap.min.js') }}"></script>         
    <script src="{{ asset('bundles/expediente/plugins/print/printArea.js') }}"></script> 
    <script src="{{ asset('bundles/expediente/plugins/dropzone/dist/dropzone.js') }}"></script>
    <script src="{{ asset('bundles/expediente/plugins/datatables/jquery.dataTables.min.js') }}"></script>
    <script src="{{ asset('bundles/expediente/plugins/clipboard/dist/clipboard.min.js') }}"></script>
    <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
<script>    
{# obtengo los reportes para ITEMPEDIDO #}
{# set itemsPorTrimestreSaf, itemsPorRubroSaf= tramites_por_trimestre_saf(2,anio, app.user.departamentoRm.organismo.id), tramites_por_rubro_saf(2,anio, app.user.departamentoRm.organismo.id) #}
{% set itemsPorTrimestreSaf, itemsPorRubroSaf= tramites_por_trimestre(2,anio), tramites_por_rubro(2,anio) %}

$('#selectAll').click( function(){ 
    $('input').prop('checked', false);              
})

    $(function () {
    $(".tablaTramite").DataTable({"searching": true,"lengthChange": true, "order": [[ 0, "desc" ]],"pageLength": 25,
            "language": {
                "url": "{{asset('bundles/expediente/plugins/datatables/extensions/language/Spanish.json')}}"
            },"lengthMenu": [[10, 25, 50, 100,-1], [10, 25, 50, 100, "Todo"]],
        });
    });
$(function () {

  CanvasJS.addCultureInfo("es", 
    {      
      decimalSeparator: ",",// Observe ToolTip Number Format
      digitGroupSeparator: ".", // Observe axisY labels                   
      days: ["domingo", "lunes", "martes", "miércoles", "jueves", "viernes", "sábado"]
      
    });

///GRAFICO CANTIDAD DE ITEMS POR TRIMESTRE
var chart = new CanvasJS.Chart("chartTrimestre", {
  theme: "light2", // "light2", "dark1", "dark2"
  culture: "es",
  animationEnabled: false, // change to true    
  title:{
    text: ""
  },
  data: [
  {
    // Change type to "bar", "area", "spline", "pie",etc.
    type: "column",
    toolTipContent: "<b>{label}</b><br>Cantidad de ítems: {cantidad}<br>Presupuesto: $ {presupuesto}",
    dataPoints: [
      {% for reporte in itemsPorTrimestreSaf %}
        { label: "{{reporte.trimestre}} ° Trimestre",  y: {{reporte.presupuesto}}, cantidad:'{{reporte.cantidad}}', presupuesto:'{{reporte.presupuesto | number_format(2, ',', '.')}}' },
      {% endfor %}
    ]
  }
  ]
});
chart.render();

///GRAFICO RUBRO POR TOTAL POR RUBRO Y AÑO
var chart = new CanvasJS.Chart("chartRubro", {
  culture: "es",
  animationEnabled: true,
  
  title:{
    text:""
  },
  axisX:{
    interval: 1
  },
  axisY2:{
    interlacedColor: "rgba(1,77,101,.2)",
    gridColor: "rgba(1,77,101,.1)",
    title: ""
  },
  data: [{
    type: "bar",
    name: "Rubros",
    axisYType: "secondary",
    toolTipContent: "<b>{rubro}</b><br>Cantidad de ítems: {cantidad}<br>Presupuesto: $ {presupuesto}",
    dataPoints: [
          {% for reporte in itemsPorRubroSaf %}
                { y: {{reporte.presupuesto}}, label: '{{reporte.tramite.rubro.ipp}}', rubro:'{{reporte.tramite.rubro}}', cantidad:'{{reporte.cantidad}}', presupuesto:'{{reporte.presupuesto | number_format(2, ',', '.')}}'},
          {% endfor %} 
    ]
  }]
});
chart.render();
});

   function currencyFormatDE(num) {
  return (
    '$ ' + num
              .toFixed(2) // always two decimal digits
              .replace('.', ',') // replace decimal point character with ,
              .replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.')
  ) // use . as a separator
}
{% set meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto",  "Septiembre",  "Octubre", "Noviembre", "Diciembre"] %}
{% set reporteProcesos = app.session.get('reporteProcesos') %}
window.onload = function () {

 CanvasJS.addCultureInfo("es", 
    {      
      decimalSeparator: ",",// Observe ToolTip Number Format
      digitGroupSeparator: ".", // Observe axisY labels                   
      days: ["domingo", "lunes", "martes", "miércoles", "jueves", "viernes", "sábado"],
      months: ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"]
      
    });
var chart = new CanvasJS.Chart("chartContainer", {
  theme: "light1", // "light2", "dark1", "dark2"
  culture: "es",
  animationEnabled: true,
  axisY: {
    title: "Montos",
    includeZero: true
  },
  legend: {
    cursor:"pointer",
    itemclick : toggleDataSeries
  },
  toolTip: {
    shared: true,
    content: toolTipFormatter
  },
  data: [{
    type: "bar",
    showInLegend: true,
    name: "Presupestado",
    color: "gold",
    dataPoints: [
{% for reporte  in reporteProcesos %}
{ y: {{reporte.montoPresupuestado}}, label: {% if reporte.mes == 0 %} '{{meses[reporte.mes ]}}' {% else %} '{{meses[reporte.mes - 1]}}' {% endif %} },
{% endfor %}
    ]
  },
  {
    type: "bar",
    showInLegend: true,
    name: "Adjudicado",
    color: "green",
    dataPoints: [
{% for reporte  in reporteProcesos %}
{ y: {{reporte.montoAdjudicado}}, label: {% if reporte.mes == 0 %} '{{meses[reporte.mes ]}}' {% else %} '{{meses[reporte.mes - 1]}}' {% endif %} },
{% endfor %}
    ]
  }]
});
chart.render();

function toolTipFormatter(e) {
  var str = "";
  var total = 0 ;
  var str3;
  var str2 ;
  for (var i = 0; i < e.entries.length; i++){
    var str1 = "<span style= \"color:"+e.entries[i].dataSeries.color + "\">" + e.entries[i].dataSeries.name + "</span>: <strong>"+  currencyFormatDE(e.entries[i].dataPoint.y) + "</strong> <br/>" ;
    total = e.entries[i].dataPoint.y - total;
    str = str.concat(str1);
  }
  str2 = "<strong>" + e.entries[0].dataPoint.label + "</strong> <br/>";

  str3 = "<span style = \"color:Tomato\">Diferencia: </span><strong>" + currencyFormatDE(total) + "</strong><br/>";
  return (str2.concat(str)).concat(str3);
}

function toggleDataSeries(e) {
  if (typeof (e.dataSeries.visible) === "undefined" || e.dataSeries.visible) {
    e.dataSeries.visible = false;
  }
  else {
    e.dataSeries.visible = true;
  }
  chart.render();
}

}
</script>
{% endblock %}